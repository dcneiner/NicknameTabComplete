/*! 
 * Nickname Tab Complete
 * Copyright (c) Doug Neiner, 2010. Dual licenses under MIT or GPL
 *
 * Includes one function from jQuery plugin: fieldSelection - v0.1.1 (c) 2006 Alex Brem <alex@0xab.cd> - http://blog.0xab.cd (Open Source)
 * 
 * And two functions from an answer 
 * by CMS (http://stackoverflow.com/users/5445/cms) on Stack Overflow:
 * http://stackoverflow.com/questions/499126/jquery-set-cursor-position-in-text-area
 *
 */
(function(i){function k(b){return("selectionStart"in b&&function(){var e=b.selectionEnd-b.selectionStart;return{start:b.selectionStart,end:b.selectionEnd,length:e,text:b.value.substr(b.selectionStart,e)}}||document.selection&&function(){b.focus();var e=document.selection.createRange();if(e===null)return{start:0,end:b.value.length,length:0};var c=b.createTextRange(),a=c.duplicate();c.moveToBookmark(e.getBookmark());a.setEndPoint("EndToStart",c);return{start:a.text.length,end:a.text.length+e.text.length,
 length:e.text.length,text:e.text}}||function(){return null})()}function l(b,e){var c=b.toLowerCase(),a=[],g=b.length,d="",f,h=0;i.each(e,function(m,j){j.toLowerCase().substr(0,g)===c&&a.push(j)});if(a.length===1)return{value:a[0],matches:a};else if(a.length>1){for(;h<a[0].length-g;h+=1){f=a[0].toLowerCase().substr(g+h,1);i.each(a,function(m,j){if(j.toLowerCase().substr(g+h,1)!==f){f="";return false}});if(f)d+=f;else break}return{value:b+d,matches:a}}return{value:"",matches:a}}i.fn.nicknameTabComplete=
 function(b){b=i.extend({},i.fn.nicknameTabComplete.defaults,b);this.bind("keydown",function(e){var c=b;if(e.which===9){var a=i(this),g=a.val(),d=k(this),f="",h="";if(!d.length&&d.start){f=g.substr(0,d.start);if(c.nick_match.test(f)){f=f.match(c.nick_match)[1];h=l(f,c.nicknames);c=i.Event("nickname-complete");i.extend(c,h);a.trigger(c);if(h.value&&!c.isDefaultPrevented()){c=g.slice(0,d.start-f.length);g=g.slice(d.start);space=h.matches.length>1||g.length&&g[0]==" "?"":" ";a.val(c+h.value+space+g);
 a=d.start-f.length+h.value.length+space.length;if(this.setSelectionRange){this.focus();this.setSelectionRange(a,a)}else if(this.createTextRange){d=this.createTextRange();d.collapse(true);d.moveEnd("character",a);d.moveStart("character",a);d.select()}}e.preventDefault()}}}});b.on_complete!==null&&this.bind("nickname-complete",b.on_complete);return this};i.fn.nicknameTabComplete.defaults={nicknames:[],nick_match:/@([-_a-z]*)$/i,on_complete:null}})(jQuery);