/*! 
 * Nickname Tab Complete
 * Copyright (c) Doug Neiner, 2010. Dual licenses under MIT or GPL
 *
 * Includes one function from jQuery plugin: fieldSelection - v0.1.1 (c) 2006 Alex Brem <alex@0xab.cd> - http://blog.0xab.cd (Open Source)
 * 
 * And two functions from an answer 
 * by CMS (http://stackoverflow.com/users/5445/cms) on Stack Overflow:
 * http://stackoverflow.com/questions/499126/jquery-set-cursor-position-in-text-area
 *
 */
(function(i){function k(b){return("selectionStart"in b&&function(){var d=b.selectionEnd-b.selectionStart;return{start:b.selectionStart,end:b.selectionEnd,length:d,text:b.value.substr(b.selectionStart,d)}}||document.selection&&function(){b.focus();var d=document.selection.createRange();if(d===null)return{start:0,end:b.value.length,length:0};var f=b.createTextRange(),a=f.duplicate();f.moveToBookmark(d.getBookmark());a.setEndPoint("EndToStart",f);return{start:a.text.length,end:a.text.length+d.text.length,
 length:d.text.length,text:d.text}}||function(){return null})()}function l(b,d){var f=b.toLowerCase(),a=[],g=b.length,c="",e,h=0;i.each(d,function(m,j){j.toLowerCase().substr(0,g)===f&&a.push(j)});if(a.length===1)return a[0];else if(a.length>1){for(;h<a[0].length-g;h+=1){e=a[0].toLowerCase().substr(g+h,1);i.each(a,function(m,j){if(j.toLowerCase().substr(g+h,1)!==e){e="";return false}});if(e)c+=e;else break}return b+c}return""}i.fn.nicknameTabComplete=function(b){b=i.extend({},i.fn.nicknameTabComplete.defaults,
 b);return this.bind("keydown",function(d){var f=b;if(d.which===9){var a=i(this),g=a.val(),c=k(this),e="",h="";if(!c.length&&c.start){e=g.substr(0,c.start);if(f.nick_match.test(e)){e=e.match(f.nick_match)[1];if(h=l(e,f.nicknames)){f=g.slice(0,c.start-e.length);g=g.slice(c.start);a.val(f+h+g);a=c.start-e.length+h.length;if(this.setSelectionRange){this.focus();this.setSelectionRange(a,a)}else if(this.createTextRange){c=this.createTextRange();c.collapse(true);c.moveEnd("character",a);c.moveStart("character",
 a);c.select()}}d.preventDefault()}}}})};i.fn.nicknameTabComplete.defaults={nicknames:[],nick_match:/@([-_a-z]*)$/i}})(jQuery);